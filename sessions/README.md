# AgentBus ä¼šè¯ç®¡ç†ç³»ç»Ÿ

AgentBus ä¼šè¯ç®¡ç†ç³»ç»Ÿä¸º AgentBus æä¾›äº†å®Œæ•´çš„ä¼šè¯ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¼šè¯åˆ›å»ºã€ä¿å­˜ã€æ¢å¤ã€æ¸…ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒå¤šç”¨æˆ·ä¼šè¯å’Œå¹¶å‘ç®¡ç†ï¼Œå®ç°äº†ä¼šè¯è¿‡æœŸå’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶ã€‚

## ğŸ†• æ–°å¢åŠŸèƒ½ç‰¹æ€§

### ğŸš€ å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ
- **ç»Ÿä¸€æ¥å£**: æ•´åˆæ‰€æœ‰ä¼šè¯ç®¡ç†åŠŸèƒ½çš„ç»Ÿä¸€ç³»ç»Ÿ
- **æ¨¡å—åŒ–è®¾è®¡**: æ”¯æŒæŒ‰éœ€å¯ç”¨ä¸åŒåŠŸèƒ½æ¨¡å—
- **é…ç½®ç®¡ç†**: çµæ´»çš„é…ç½®ç³»ç»Ÿå’Œé¢„è®¾é…ç½®
- **å¥åº·ç›‘æ§**: å®Œæ•´çš„ç³»ç»Ÿå¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§

### ğŸ”„ ä¼šè¯åŒæ­¥ç³»ç»Ÿ
- **è·¨é€šé“åŒæ­¥**: æ”¯æŒå¤šå¹³å°ã€å¤šé€šé“çš„ä¼šè¯å…³è”å’ŒåŒæ­¥
- **èº«ä»½æ˜ å°„**: æ™ºèƒ½çš„ç”¨æˆ·èº«ä»½è¯†åˆ«å’Œæ˜ å°„
- **å†²çªè§£å†³**: å¤šç§ä¼šè¯å†²çªè§£å†³ç­–ç•¥
- **è‡ªåŠ¨åŒæ­¥**: æ”¯æŒæ‰‹åŠ¨ã€è‡ªåŠ¨ã€å»¶è¿Ÿå’Œæ‰¹é‡åŒæ­¥

### ğŸ’¾ ä¼šè¯æŒä¹…åŒ–
- **å¤šæ ¼å¼å¤‡ä»½**: æ”¯æŒJSONã€å‹ç¼©JSONã€Pickleç­‰å¤šç§æ ¼å¼
- **è‡ªåŠ¨å¤‡ä»½**: å¯é…ç½®çš„è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
- **å¢é‡å¤‡ä»½**: æ™ºèƒ½çš„å¢é‡å¤‡ä»½å’Œæ¢å¤
- **å®Œæ•´æ€§éªŒè¯**: å¤‡ä»½æ–‡ä»¶çš„æ ¡éªŒå’Œå®Œæ•´æ€§æ£€æŸ¥

### ğŸ“Š ä¼šè¯çŠ¶æ€è·Ÿè¸ª
- **çŠ¶æ€æœº**: å¯é…ç½®çš„çŠ¶æ€è½¬æ¢è§„åˆ™
- **äº‹ä»¶è·Ÿè¸ª**: å…¨é¢çš„ä¼šè¯äº‹ä»¶è®°å½•å’Œåˆ†æ
- **æ¨¡å¼åˆ†æ**: è‡ªåŠ¨è¯†åˆ«ä½¿ç”¨æ¨¡å¼å’Œè¶‹åŠ¿
- **é¢„æµ‹åŠŸèƒ½**: æ™ºèƒ½çš„ç”Ÿå‘½å‘¨æœŸé¢„æµ‹

### â° ä¼šè¯è¿‡æœŸç®¡ç†
- **å¤šç­–ç•¥è¿‡æœŸ**: æ—¶é—´ã€æ´»åŠ¨ã€ä½¿ç”¨é‡ã€æ··åˆç­‰å¤šç§è¿‡æœŸç­–ç•¥
- **æ™ºèƒ½æ¸…ç†**: å¯é…ç½®çš„æ¸…ç†æ“ä½œå’Œé€šçŸ¥æœºåˆ¶
- **æ¸è¿›å¼è¿‡æœŸ**: åŸºäºä¼˜å…ˆçº§çš„æ¸è¿›å¼è¿‡æœŸå¤„ç†
- **å½’æ¡£åŠŸèƒ½**: è‡ªåŠ¨å½’æ¡£å’Œæ¢å¤åŠŸèƒ½

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ğŸ’¼ åŸºç¡€åŠŸèƒ½
- **ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åˆ›å»ºã€ä¿å­˜ã€æ¢å¤ã€åˆ é™¤ä¼šè¯
- **å¤šç”¨æˆ·æ”¯æŒ**: æ”¯æŒå¤šç”¨æˆ·ä¼šè¯å’Œå¹¶å‘ç®¡ç†
- **è‡ªåŠ¨æ¸…ç†**: ä¼šè¯è¿‡æœŸå’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶
- **æ¶ˆæ¯å†å²**: å®Œæ•´çš„å¯¹è¯å†å²è®°å½•å’Œç®¡ç†
- **çˆ¶å­ä¼šè¯**: æ”¯æŒä¼šè¯çš„å±‚çº§å…³ç³»ç®¡ç†

### ğŸ’¾ å­˜å‚¨æ”¯æŒ
- **å†…å­˜å­˜å‚¨**: å¿«é€Ÿè®¿é—®ï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•
- **æ–‡ä»¶å­˜å‚¨**: åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„æŒä¹…åŒ–å­˜å‚¨
- **æ•°æ®åº“å­˜å‚¨**: SQLiteæ•°æ®åº“å­˜å‚¨ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
- **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„å­˜å‚¨åç«¯

### ğŸ›  ç®¡ç†å·¥å…·
- **ä¸Šä¸‹æ–‡ç®¡ç†å™¨**: é«˜æ•ˆçš„ä¸Šä¸‹æ–‡ç¼“å­˜å’Œç®¡ç†
- **ä¼šè¯è£…é¥°å™¨**: ä¾¿æ·çš„ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- **å¥åº·æ£€æŸ¥**: ç³»ç»ŸçŠ¶æ€ç›‘æ§å’Œè¯Šæ–­
- **ç»Ÿè®¡ä¿¡æ¯**: è¯¦ç»†çš„ä¼šè¯ç»Ÿè®¡å’Œåˆ†æ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
agentbus/sessions/
â”œâ”€â”€ __init__.py                    # æ¨¡å—åˆå§‹åŒ–å’Œå…¬å…±æ¥å£
â”œâ”€â”€ session_manager.py            # ä¼šè¯ç®¡ç†å™¨æ ¸å¿ƒå®ç°
â”œâ”€â”€ session_storage.py            # ä¼šè¯å­˜å‚¨æŠ½è±¡å’Œå®ç°
â”œâ”€â”€ context_manager.py            # ä¸Šä¸‹æ–‡ç®¡ç†å™¨
â”œâ”€â”€ test_sessions.py            # åŠŸèƒ½æµ‹è¯•è„šæœ¬
â”œâ”€â”€ README.md                   # ä½¿ç”¨æ–‡æ¡£

# ğŸ†• æ–°å¢æ‰©å±•æ¨¡å—
â”œâ”€â”€ session_sync.py              # è·¨é€šé“ä¼šè¯åŒæ­¥
â”œâ”€â”€ session_persistence.py      # ä¼šè¯æŒä¹…åŒ–å’Œæ¢å¤
â”œâ”€â”€ session_state_tracker.py     # ä¼šè¯çŠ¶æ€è·Ÿè¸ª
â”œâ”€â”€ session_expiry.py           # ä¼šè¯è¿‡æœŸå¤„ç†
â”œâ”€â”€ session_system.py          # å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ
â””â”€â”€ demo_complete_system.py    # å®Œæ•´ç³»ç»Ÿæ¼”ç¤ºè„šæœ¬
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä½¿ç”¨

```python
import asyncio
from agentbus.sessions import (
    initialize_sessions, create_session, get_session, add_message,
    Platform, SessionType, Message, MessageType
)

async def main():
    # 1. åˆå§‹åŒ–ä¼šè¯ç®¡ç†ç³»ç»Ÿ
    system = await initialize_sessions()
    
    # 2. åˆ›å»ºä¼šè¯
    session = await create_session(
        chat_id="chat_123",
        user_id="user_456", 
        platform=Platform.TELEGRAM,
        session_type=SessionType.PRIVATE
    )
    
    # 3. æ·»åŠ æ¶ˆæ¯
    message = Message(
        id="msg_001",
        content="ä½ å¥½ï¼è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
        user_id="user_456",
        timestamp=datetime.now(),
        message_type=MessageType.TEXT,
        platform=Platform.TELEGRAM,
        chat_id="chat_123"
    )
    
    await add_message(session.session_id, message)
    
    # 4. è·å–ä¼šè¯
    retrieved_session = await get_session(session.session_id)
    print(f"ä¼šè¯åŒ…å« {len(retrieved_session.conversation_history)} æ¡æ¶ˆæ¯")

asyncio.run(main())
```

### ğŸ†• å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ

```python
import asyncio
from agentbus.sessions import (
    initialize_sessions, 
    get_development_config,
    EventType,
    default_notification_callback
)

async def main():
    # 1. åˆ›å»ºå¼€å‘ç¯å¢ƒé…ç½®
    config = get_development_config()
    config.update({
        "enable_sync": True,           # å¯ç”¨ä¼šè¯åŒæ­¥
        "enable_persistence": True,    # å¯ç”¨æŒä¹…åŒ–
        "enable_tracking": True,       # å¯ç”¨çŠ¶æ€è·Ÿè¸ª
        "enable_expiry": True,         # å¯ç”¨è¿‡æœŸç®¡ç†
    })
    
    # 2. åˆå§‹åŒ–å®Œæ•´ä¼šè¯ç³»ç»Ÿ
    system = await initialize_sessions(
        storage_type="DATABASE",
        storage_config={"db_path": "./agentbus.db"},
        enable_all_features=True,
        **config.__dict__
    )
    
    try:
        # 3. åˆ›å»ºä¼šè¯
        session = await system.create_session(
            chat_id="chat_123",
            user_id="user_456",
            platform=Platform.TELEGRAM,
            session_type=SessionType.PRIVATE,
            ai_model="gpt-3.5-turbo"
        )
        
        # 4. è·Ÿè¸ªäº‹ä»¶
        await system.track_event(
            session.session_id,
            EventType.MESSAGE_RECEIVED,
            content="ä½ å¥½ï¼è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
            user_id="user_456"
        )
        
        # 5. åˆ›å»ºå¤‡ä»½
        backup_id = await system.create_backup(
            description="é‡è¦å¤‡ä»½",
            tags=["important", "test"]
        )
        
        # 6. è·å–ç³»ç»ŸçŠ¶æ€
        status = await system.get_system_status()
        print(f"ç³»ç»ŸçŠ¶æ€: {status['system']['status']}")
        print(f"æ´»è·ƒä¼šè¯: {status['metrics']['active_sessions']}")
        
    finally:
        await system.stop()

asyncio.run(main())
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
import asyncio
from pathlib import Path
from agentbus.sessions import (
    initialize_sessions,
    get_production_config,
    create_email_notification_callback,
    ExpiryRule,
    ExpiryStrategy,
    CleanupAction
)

async def main():
    # 1. åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
    config = get_production_config(
        storage_config={"db_path": "/var/lib/agentbus/sessions.db"},
        backup_dir=Path("/var/backups/agentbus"),
        archive_dir=Path("/var/archive/agentbus")
    )
    
    # 2. æ·»åŠ è‡ªå®šä¹‰è¿‡æœŸè§„åˆ™
    expiry_rule = ExpiryRule(
        rule_id="production_archive",
        name="ç”Ÿäº§ç¯å¢ƒå½’æ¡£è§„åˆ™",
        strategy=ExpiryStrategy.TIME_BASED,
        conditions={"default_hours": 24},
        actions=[CleanupAction.ARCHIVE],
        priority=1
    )
    
    # 3. æ·»åŠ é€šçŸ¥å›è°ƒ
    email_callback = create_email_notification_callback({
        "smtp_server": "smtp.company.com",
        "recipients": ["admin@company.com"]
    })
    
    config.notification_callbacks = [email_callback]
    
    # 4. åˆå§‹åŒ–ç³»ç»Ÿ
    system = await initialize_sessions(**config.__dict__)
    
    try:
        # 5. ä¸šåŠ¡é€»è¾‘...
        pass
    finally:
        await system.stop()

asyncio.run(main())
```

### ä½¿ç”¨ä¸åŒå­˜å‚¨ç±»å‹

```python
# å†…å­˜å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰
manager = await initialize_sessions()

# æ–‡ä»¶å­˜å‚¨
manager = await initialize_sessions(
    storage_type=StorageType.FILE,
    storage_config={"storage_dir": "./sessions_data"}
)

# æ•°æ®åº“å­˜å‚¨
manager = await initialize_sessions(
    storage_type=StorageType.DATABASE,
    storage_config={"db_path": "./agentbus_sessions.db"}
)
```

### ä½¿ç”¨ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
from agentbus.sessions import session_context, get_session_manager

async def handle_user_message():
    manager = get_session_manager()
    
    async with session_context(
        manager,
        chat_id="chat_123",
        user_id="user_456",
        platform=Platform.TELEGRAM
    ) as session:
        # åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œä¼šè¯ä¼šè¢«è‡ªåŠ¨åˆ›å»ºæˆ–è·å–
        print(f"å¤„ç†ä¼šè¯: {session.session_id}")
        
        # æ·»åŠ ä¸€äº›æ•°æ®åˆ°ä¼šè¯
        session.set_data("user_preferences", {"theme": "dark"})
        
        # ä½ çš„ä¸šåŠ¡é€»è¾‘...
        
        return session.session_id
```

## ğŸ”§ API å‚è€ƒ

### æ ¸å¿ƒç±»

#### SessionContext
ä¼šè¯ä¸Šä¸‹æ–‡ç±»ï¼ŒåŒ…å«ä¼šè¯çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```python
# å±æ€§
session_id: str              # ä¼šè¯å”¯ä¸€æ ‡è¯†
chat_id: str                 # èŠå¤©ID
user_id: str                 # ç”¨æˆ·ID
platform: Platform          # å¹³å°ç±»å‹
session_type: SessionType    # ä¼šè¯ç±»å‹
created_at: datetime         # åˆ›å»ºæ—¶é—´
last_activity: datetime      # æœ€åæ´»åŠ¨æ—¶é—´
data: Dict[str, Any]         # ä¼šè¯æ•°æ®
metadata: Dict[str, Any]     # ä¼šè¯å…ƒæ•°æ®
conversation_history: List   # å¯¹è¯å†å²

# æ–¹æ³•
add_message(message)         # æ·»åŠ æ¶ˆæ¯
set_data(key, value)         # è®¾ç½®æ•°æ®
get_data(key, default)       # è·å–æ•°æ®
is_expired()                 # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
is_active()                  # æ£€æŸ¥æ˜¯å¦æ´»è·ƒ
```

#### SessionManager
ä¼šè¯ç®¡ç†å™¨ï¼Œè´Ÿè´£ä¼šè¯çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

```python
# åˆ›å»ºä¼šè¯
create_session(chat_id, user_id, platform, session_type, **kwargs)

# è·å–ä¼šè¯
get_session(session_id)
get_user_session(user_id, chat_id, platform)
get_user_sessions(user_id)

# æ›´æ–°ä¼šè¯
update_session(context)
add_message_to_session(session_id, message)

# åˆ é™¤ä¼šè¯
delete_session(session_id)

# ç”Ÿå‘½å‘¨æœŸç®¡ç†
extend_session_lifetime(session_id, seconds)
reset_session_history(session_id, keep_recent)
cleanup_all_expired()
```

### ğŸ†• å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ

#### SessionSystem
ç»Ÿä¸€ä¼šè¯ç®¡ç†ç³»ç»Ÿï¼Œæ•´åˆæ‰€æœ‰åŠŸèƒ½æ¨¡å—ã€‚

```python
# ç³»ç»Ÿç®¡ç†
await system.start()                    # å¯åŠ¨ç³»ç»Ÿ
await system.stop()                     # åœæ­¢ç³»ç»Ÿ
await system.restart()                  # é‡å¯ç³»ç»Ÿ

# ä¼šè¯æ“ä½œ
await system.get_session(session_id)   # è·å–ä¼šè¯
await system.create_session(**kwargs)   # åˆ›å»ºä¼šè¯
await system.delete_session(session_id) # åˆ é™¤ä¼šè¯

# äº‹ä»¶è·Ÿè¸ª
await system.track_event(session_id, EventType.MESSAGE_RECEIVED, **data)

# åŒæ­¥æ“ä½œ
await system.sync_sessions(source_session_id)

# å¤‡ä»½æ¢å¤
await system.create_backup(description="å¤‡ä»½è¯´æ˜", **options)
await system.restore_backup(backup_id, **options)

# æ¸…ç†æ“ä½œ
await system.cleanup_expired_sessions(dry_run=False)

# ç³»ç»Ÿç›‘æ§
await system.get_system_status()       # è·å–ç³»ç»ŸçŠ¶æ€
await system.get_health_check()        # å¥åº·æ£€æŸ¥
```

#### é…ç½®ç®¡ç†

```python
# è·å–å¼€å‘ç¯å¢ƒé…ç½®
config = get_development_config()

# è·å–ç”Ÿäº§ç¯å¢ƒé…ç½®
config = get_production_config(
    storage_config={"db_path": "./prod.db"},
    backup_dir=Path("./backups"),
    archive_dir=Path("./archive")
)

# è‡ªå®šä¹‰é…ç½®
config = SessionSystemConfig(
    storage_type=StorageType.DATABASE,
    enable_sync=True,
    enable_persistence=True,
    enable_tracking=True,
    enable_expiry=True,
    backup_dir=Path("./backups"),
    archive_dir=Path("./archive")
)
```

### ğŸ”„ ä¼šè¯åŒæ­¥ç³»ç»Ÿ

#### SessionSynchronizer
è·¨é€šé“ä¼šè¯åŒæ­¥ç®¡ç†å™¨ã€‚

```python
# åˆ›å»ºåŒæ­¥å™¨
synchronizer = await create_session_sync(session_store, sync_config)

# èº«ä»½æ˜ å°„
await synchronizer.link_identities(
    identity_key="user_123",
    session_ids=["session_1", "session_2"],
    display_name="å¼ ä¸‰"
)

# åŒæ­¥ä¼šè¯
await synchronizer.sync_sessions(source_session_id)

# å†²çªè§£å†³
await synchronizer.resolve_session_conflicts(session_ids, "latest_wins")
```

### ğŸ’¾ ä¼šè¯æŒä¹…åŒ–

#### SessionPersistence
ä¼šè¯æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨ã€‚

```python
# åˆ›å»ºæŒä¹…åŒ–ç®¡ç†å™¨
persistence = await create_session_persistence(session_store, backup_dir)

# å¤‡ä»½æ“ä½œ
backup_id = await persistence.create_backup(
    format=BackupFormat.JSON_GZ,
    description="é‡è¦æ•°æ®å¤‡ä»½",
    tags=["important", "daily"]
)

# æ¢å¤æ“ä½œ
result = await persistence.restore_backup(
    backup_id,
    options=RecoveryOptions(
        strategy=RecoveryStrategy.MERGE,
        preserve_metadata=True
    )
)

# å¯¼å‡ºå¯¼å…¥
export_path = await persistence.export_session(session_id, BackupFormat.JSON)
await persistence.import_session(export_path)
```

### ğŸ“Š ä¼šè¯çŠ¶æ€è·Ÿè¸ª

#### SessionStateTracker
ä¼šè¯çŠ¶æ€è·Ÿè¸ªå’Œäº‹ä»¶è®°å½•ç®¡ç†å™¨ã€‚

```python
# åˆ›å»ºè·Ÿè¸ªå™¨
tracker = await create_session_state_tracker(session_store)

# è·Ÿè¸ªäº‹ä»¶
await tracker.track_event(
    session_id,
    EventType.MESSAGE_RECEIVED,
    content="æ¶ˆæ¯å†…å®¹",
    user_id="user_123"
)

# çŠ¶æ€å˜æ›´
await tracker.track_session_state_change(
    session_id,
    SessionStatus.IDLE,
    StateTransitionType.AUTOMATIC,
    "idle_detected"
)

# è·å–ç»Ÿè®¡
stats = await tracker.get_state_statistics(timedelta(days=7))
prediction = await tracker.predict_session_lifecycle(session_id)
```

### â° ä¼šè¯è¿‡æœŸç®¡ç†

#### SessionExpiryManager
ä¼šè¯è¿‡æœŸæ£€æµ‹å’Œæ¸…ç†ç®¡ç†å™¨ã€‚

```python
# åˆ›å»ºè¿‡æœŸç®¡ç†å™¨
expiry_manager = await create_expiry_manager(
    session_store,
    archive_dir=Path("./archive")
)

# æ·»åŠ è¿‡æœŸè§„åˆ™
rule = ExpiryRule(
    rule_id="30d_archive",
    name="30å¤©å½’æ¡£",
    strategy=ExpiryStrategy.TIME_BASED,
    conditions={"default_hours": 720},  # 30å¤©
    actions=[CleanupAction.ARCHIVE],
    priority=1
)
await expiry_manager.add_expiry_rule(rule)

# æ¸…ç†è¿‡æœŸä¼šè¯
results = await expiry_manager.cleanup_expired_sessions()

# è·å–ç»Ÿè®¡
stats = await expiry_manager.get_expiry_statistics()
```

### å­˜å‚¨æ¥å£

#### SessionStore
ä¼šè¯å­˜å‚¨æŠ½è±¡æ¥å£ã€‚

```python
# åŸºæœ¬æ“ä½œ
create_session(context)
get_session(session_id)
update_session(context)
delete_session(session_id)

# æŸ¥è¯¢
find_sessions(**filters)
cleanup_expired()
get_session_count()
```

#### å­˜å‚¨å®ç°
- `MemorySessionStore`: å†…å­˜å­˜å‚¨
- `FileSessionStore`: æ–‡ä»¶å­˜å‚¨
- `DatabaseSessionStore`: æ•°æ®åº“å­˜å‚¨

### ä¾¿åˆ©å‡½æ•°

```python
# å…¨å±€å‡½æ•°
create_session(**kwargs)      # åˆ›å»ºä¼šè¯
get_session(session_id)       # è·å–ä¼šè¯
add_message(session_id, msg)  # æ·»åŠ æ¶ˆæ¯

# ä¸Šä¸‹æ–‡ç®¡ç†
session_context(manager, chat_id, user_id, platform, **kwargs)

# ç³»ç»Ÿç®¡ç†
initialize_sessions(**config)    # åˆå§‹åŒ–ç³»ç»Ÿ
shutdown_sessions()              # å…³é—­ç³»ç»Ÿ
health_check()                   # å¥åº·æ£€æŸ¥
```

## é…ç½®é€‰é¡¹

### åˆå§‹åŒ–é…ç½®

```python
config = {
    "storage_type": StorageType.MEMORY,      # å­˜å‚¨ç±»å‹
    "storage_config": {},                     # å­˜å‚¨é…ç½®
    "enable_cleanup": True,                   # å¯ç”¨è‡ªåŠ¨æ¸…ç†
    "cleanup_interval": 300,                  # æ¸…ç†é—´éš”ï¼ˆç§’ï¼‰
    "max_history_per_session": 50,           # æœ€å¤§å†å²è®°å½•æ•°
    "idle_timeout": 3600,                    # ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰
}

manager = await initialize_sessions(**config)
```

### ä¼šè¯é…ç½®

```python
# åˆ›å»ºä¼šè¯æ—¶è®¾ç½®é…ç½®
session = await create_session(
    chat_id="chat_123",
    user_id="user_456",
    platform=Platform.TELEGRAM,
    
    # ä¼šè¯å…ƒæ•°æ®
    max_history=100,           # æœ€å¤§å†å²è®°å½•æ•°
    idle_timeout=7200,        # ç©ºé—²è¶…æ—¶ï¼ˆ2å°æ—¶ï¼‰
    expires_in=86400,          # è¿‡æœŸæ—¶é—´ï¼ˆ1å¤©ï¼‰
    ai_model="gpt-3.5-turbo", # AIæ¨¡å‹
    custom_data={}            # è‡ªå®šä¹‰æ•°æ®
)
```

## æœ€ä½³å®è·µ

### 1. é€‚å½“çš„å­˜å‚¨é€‰æ‹©

```python
# å¼€å‘/æµ‹è¯•ï¼šä½¿ç”¨å†…å­˜å­˜å‚¨
manager = await initialize_sessions(StorageType.MEMORY)

# ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æ•°æ®åº“å­˜å‚¨
manager = await initialize_sessions(
    storage_type=StorageType.DATABASE,
    storage_config={"db_path": "/var/lib/agentbus/sessions.db"}
)
```

### 2. ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
# è‡ªåŠ¨æ¸…ç†
manager = await initialize_sessions(enable_cleanup=True)

# æ‰‹åŠ¨æ¸…ç†
await manager.cleanup_all_expired()

# æ‰¹é‡æ¸…ç†æ—§ä¼šè¯
await manager.batch_cleanup(older_than_days=30)
```

### 3. é”™è¯¯å¤„ç†

```python
async def safe_session_operation():
    try:
        session = await create_session(...)
        # ä¸šåŠ¡é€»è¾‘...
        return True
    except Exception as e:
        logger.error(f"ä¼šè¯æ“ä½œå¤±è´¥: {e}")
        return False
```

### 4. æ€§èƒ½ä¼˜åŒ–

```python
# å¯ç”¨ä¼šè¯ä¸Šä¸‹æ–‡è£…é¥°å™¨
async with session_context(manager, ...) as session:
    # åœ¨å•ä¸ªæ“ä½œä¸­å¤„ç†å¤šä¸ªç›¸å…³ä»»åŠ¡
    messages = await process_messages(session)
    await update_session(session)  # ä¸€æ¬¡æ€§æ›´æ–°

# æ‰¹é‡æ“ä½œ
for message in messages:
    await add_message(session_id, message)
```

## ğŸ§ª æµ‹è¯•

### è¿è¡ŒåŸºç¡€æµ‹è¯•
```bash
cd agentbus/sessions
python test_sessions.py
```

### ğŸ†• è¿è¡Œå®Œæ•´ç³»ç»Ÿæ¼”ç¤º
```bash
cd agentbus/sessions
python demo_complete_system.py
```

æµ‹è¯•åŒ…æ‹¬ï¼š
- âœ… åŸºæœ¬ä¼šè¯æ“ä½œ
- âœ… ä¸åŒå­˜å‚¨ç±»å‹
- âœ… ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âœ… å¹¶å‘ä¼šè¯å¤„ç†
- âœ… ğŸ†• ä¼šè¯åŒæ­¥åŠŸèƒ½
- âœ… ğŸ†• ä¼šè¯æŒä¹…åŒ–
- âœ… ğŸ†• çŠ¶æ€è·Ÿè¸ªå’Œåˆ†æ
- âœ… ğŸ†• è¿‡æœŸå¤„ç†å’Œæ¸…ç†
- âœ… ğŸ†• å®Œæ•´ç³»ç»Ÿé›†æˆ

### æ€§èƒ½æµ‹è¯•

```python
import asyncio
from agentbus.sessions import create_default_session_system

async def performance_test():
    system = await create_default_session_system(
        storage_type="MEMORY",
        enable_all_features=True
    )
    
    # åˆ›å»º100ä¸ªä¼šè¯
    start_time = datetime.now()
    sessions = []
    for i in range(100):
        session = await system.create_session(
            chat_id=f"perf_chat_{i}",
            user_id=f"perf_user_{i}",
            platform=Platform.TELEGRAM
        )
        sessions.append(session)
    
    creation_time = (datetime.now() - start_time).total_seconds()
    print(f"åˆ›å»º100ä¸ªä¼šè¯è€—æ—¶: {creation_time:.2f}ç§’")
    
    await system.stop()

asyncio.run(performance_test())
```

## ğŸ“‹ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»åˆ°å®Œæ•´ç³»ç»Ÿ

#### 1. æ›´æ–°å¯¼å…¥

```python
# æ—§çš„å¯¼å…¥æ–¹å¼
from agentbus.sessions import SessionManager, SessionContext

# æ–°çš„å¯¼å…¥æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
from agentbus.sessions import SessionManager, SessionContext

# æ–°åŠŸèƒ½å¯¼å…¥
from agentbus.sessions import (
    SessionSystem,           # å®Œæ•´ç³»ç»Ÿ
    initialize_sessions,     # åˆå§‹åŒ–å‡½æ•°
    get_development_config,  # é¢„è®¾é…ç½®
)
```

#### 2```python
#. æ›´æ–°åˆå§‹åŒ–

 æ—§çš„åˆå§‹åŒ–
manager = SessionManager()
await manager.start()

# æ–°çš„åˆå§‹åŒ–ï¼ˆåŸºç¡€æ¨¡å¼ï¼Œå‘åå…¼å®¹ï¼‰
manager = await initialize_basic_sessions()

# æ–°çš„åˆå§‹åŒ–ï¼ˆå®Œæ•´æ¨¡å¼ï¼Œæ¨èï¼‰
system = await initialize_sessions(
    storage_type=StorageType.DATABASE,
    storage_config={"db_path": "./agentbus.db"},
    enable_all_features=True
)
```

#### 3. å¯ç”¨æ–°åŠŸèƒ½

```python
# é€æ­¥å¯ç”¨æ–°åŠŸèƒ½
system = await initialize_sessions(
    storage_type=StorageType.DATABASE,
    enable_cleanup=True,
    enable_sync=True,           # å¯ç”¨ä¼šè¯åŒæ­¥
    enable_persistence=True,    # å¯ç”¨æŒä¹…åŒ–
    enable_tracking=True,        # å¯ç”¨çŠ¶æ€è·Ÿè¸ª
    enable_expiry=True          # å¯ç”¨è¿‡æœŸç®¡ç†
)
```

### ä»Moltbotè¿ç§»ä¼šè¯ç®¡ç†åŠŸèƒ½

#### 1. æ›¿æ¢å¯¼å…¥

```python
# æ—§çš„ Moltbot å¯¼å…¥
from py_moltbot.core.session import SessionManager, SessionContext

# æ–°çš„ AgentBus å¯¼å…¥
from agentbus.sessions import SessionManager, SessionContext
```

#### 2. æ›´æ–°åˆå§‹åŒ–

```python
# æ—§çš„åˆå§‹åŒ–
manager = SessionManager()
await manager.start()

# æ–°çš„åˆå§‹åŒ–
system = await initialize_sessions()
```

#### 3. æ›´æ–°APIè°ƒç”¨

å¤§å¤šæ•°APIä¿æŒå…¼å®¹ï¼Œä½†éœ€è¦æ›´æ–°ä¸€äº›æšä¸¾ç±»å‹ï¼š

```python
# å¹³å°ç±»å‹
Platform.TELEGRAM  # æ›¿ä»£åŸæ¥çš„ telegram.platform

# ä¼šè¯ç±»å‹  
SessionType.PRIVATE  # æ›¿ä»£åŸæ¥çš„ PRIVATE
```

#### 4. è¿ç§»åˆ°å®Œæ•´ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰

```python
# ä½¿ç”¨å®Œæ•´åŠŸèƒ½
system = await initialize_sessions(
    storage_type=StorageType.DATABASE,
    storage_config={"db_path": "./agentbus.db"},
    enable_all_features=True,
    backup_dir=Path("./backups"),
    archive_dir=Path("./archive")
)

# ä¿æŒç°æœ‰APIå…¼å®¹æ€§
session = await system.create_session(...)  # æ—§APIä»ç„¶å·¥ä½œ
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å­˜å‚¨è¿æ¥å¤±è´¥**
   ```python
   # æ£€æŸ¥å­˜å‚¨é…ç½®
   health = await manager.health_check()
   print(health)
   ```

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   ```python
   # è°ƒæ•´æ¸…ç†é—´éš”
   manager = await initialize_sessions(cleanup_interval=60)  # 1åˆ†é’Ÿ
   
   # å®šæœŸæ¸…ç†
   await manager.cleanup_all_expired()
   ```

3. **ä¼šè¯æ•°æ®ä¸¢å¤±**
   ```python
   # ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨
   manager = await initialize_sessions(StorageType.DATABASE)
   ```

### ç›‘æ§å’Œæ—¥å¿—

```python
import logging

# å¯ç”¨è¯¦ç»†æ—¥å¿—
logging.getLogger('agentbus.sessions').setLevel(logging.DEBUG)

# å¥åº·æ£€æŸ¥
health = await health_check()
if health['status'] != 'healthy':
    print(f"ç³»ç»ŸçŠ¶æ€å¼‚å¸¸: {health}")
```

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. è¿è¡Œæµ‹è¯•
5. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª MIT è®¸å¯è¯ã€‚

## ğŸ‰ å®Œæˆæ€»ç»“

### âœ… å·²å®ç°åŠŸèƒ½

æœ¬æ¬¡æ‰©å±•å®ç°äº†åŸºäºMoltbotä¼šè¯ç®¡ç†åŠŸèƒ½çš„å®Œæ•´AgentBusä¼šè¯ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

#### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„
- âœ… **å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ**: ç»Ÿä¸€çš„SessionSystemç±»ï¼Œæ•´åˆæ‰€æœ‰åŠŸèƒ½æ¨¡å—
- âœ… **æ¨¡å—åŒ–è®¾è®¡**: æ”¯æŒæŒ‰éœ€å¯ç”¨ä¸åŒåŠŸèƒ½ï¼Œæä¾›çµæ´»çš„é…ç½®é€‰é¡¹
- âœ… **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰APIçš„å®Œå…¨å…¼å®¹ï¼Œæ”¯æŒæ¸è¿›å¼å‡çº§

#### ğŸ”„ ä¼šè¯åŒæ­¥ç³»ç»Ÿ (session_sync.py)
- âœ… **è·¨é€šé“ä¼šè¯åŒæ­¥**: æ”¯æŒå¤šå¹³å°ã€å¤šé€šé“çš„ä¼šè¯å…³è”å’ŒåŒæ­¥
- âœ… **èº«ä»½æ˜ å°„**: æ™ºèƒ½çš„ç”¨æˆ·èº«ä»½è¯†åˆ«å’Œæ˜ å°„æœºåˆ¶
- âœ… **å†²çªè§£å†³**: æ”¯æŒlatest_winsã€manualã€source_priorityç­‰ç­–ç•¥
- âœ… **åŒæ­¥æ“ä½œ**: æ”¯æŒcreateã€updateã€deleteã€mergeç­‰æ“ä½œç±»å‹

#### ğŸ’¾ ä¼šè¯æŒä¹…åŒ– (session_persistence.py)
- âœ… **å¤šæ ¼å¼å¤‡ä»½**: æ”¯æŒJSONã€JSON_GZã€Pickleã€Pickle_GZæ ¼å¼
- âœ… **è‡ªåŠ¨å¤‡ä»½**: å¯é…ç½®çš„è‡ªåŠ¨å¤‡ä»½æœºåˆ¶å’Œä¿ç•™ç­–ç•¥
- âœ… **æ¢å¤ç­–ç•¥**: æ”¯æŒmergeã€replaceã€skipã€interactiveç­‰ç­–ç•¥
- âœ… **å®Œæ•´æ€§éªŒè¯**: å¤‡ä»½æ–‡ä»¶çš„æ ¡éªŒå’Œå®Œæ•´æ€§æ£€æŸ¥
- âœ… **å¯¼å‡ºå¯¼å…¥**: å•ä¸ªä¼šè¯çš„å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½

#### ğŸ“Š ä¼šè¯çŠ¶æ€è·Ÿè¸ª (session_state_tracker.py)
- âœ… **çŠ¶æ€æœº**: å¯é…ç½®çš„çŠ¶æ€è½¬æ¢è§„åˆ™å’Œå¤„ç†å™¨
- âœ… **äº‹ä»¶è·Ÿè¸ª**: å…¨é¢çš„ä¼šè¯äº‹ä»¶è®°å½•å’Œåˆ†æ
- âœ… **æ¨¡å¼åˆ†æ**: è‡ªåŠ¨è¯†åˆ«ä½¿ç”¨æ¨¡å¼å’Œè¶‹åŠ¿
- âœ… **é¢„æµ‹åŠŸèƒ½**: æ™ºèƒ½çš„ç”Ÿå‘½å‘¨æœŸé¢„æµ‹å’Œå»ºè®®
- âœ… **ç»Ÿè®¡æŠ¥å‘Š**: è¯¦ç»†çš„çŠ¶æ€ç»Ÿè®¡å’Œä½¿ç”¨åˆ†æ

#### â° ä¼šè¯è¿‡æœŸç®¡ç† (session_expiry.py)
- âœ… **å¤šç­–ç•¥è¿‡æœŸ**: æ—¶é—´ã€æ´»åŠ¨ã€ä½¿ç”¨é‡ã€æ··åˆã€è‡ªå®šä¹‰ç­‰ç­–ç•¥
- âœ… **æ™ºèƒ½æ¸…ç†**: æ”¯æŒarchiveã€deleteã€mergeã€suspendã€notifyç­‰æ“ä½œ
- âœ… **ä¼˜å…ˆçº§ç®¡ç†**: åŸºäºä¼˜å…ˆçº§çš„æ¸è¿›å¼è¿‡æœŸå¤„ç†
- âœ… **é€šçŸ¥æœºåˆ¶**: çµæ´»çš„è¿‡æœŸé€šçŸ¥å’Œå›è°ƒç³»ç»Ÿ
- âœ… **å½’æ¡£åŠŸèƒ½**: è‡ªåŠ¨å½’æ¡£å’Œæ¢å¤åŠŸèƒ½

#### ğŸ”§ ç³»ç»Ÿé›†æˆ (session_system.py)
- âœ… **ç»Ÿä¸€æ¥å£**: SessionSystemç±»æä¾›ç»Ÿä¸€çš„ç³»ç»Ÿæ¥å£
- âœ… **é…ç½®ç®¡ç†**: çµæ´»çš„SessionSystemConfigå’Œé¢„è®¾é…ç½®
- âœ… **å¥åº·ç›‘æ§**: å®Œæ•´çš„ç³»ç»Ÿå¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§
- âœ… **ç»„ä»¶åè°ƒ**: å„æ¨¡å—é—´çš„åè°ƒå’Œé›†æˆç®¡ç†

### ğŸ“ æ–°å¢æ–‡ä»¶

```
agentbus/sessions/
â”œâ”€â”€ session_sync.py              # è·¨é€šé“ä¼šè¯åŒæ­¥
â”œâ”€â”€ session_persistence.py       # ä¼šè¯æŒä¹…åŒ–å’Œæ¢å¤
â”œâ”€â”€ session_state_tracker.py     # ä¼šè¯çŠ¶æ€è·Ÿè¸ª
â”œâ”€â”€ session_expiry.py           # ä¼šè¯è¿‡æœŸå¤„ç†
â”œâ”€â”€ session_system.py          # å®Œæ•´ä¼šè¯ç®¡ç†ç³»ç»Ÿ
â””â”€â”€ demo_complete_system.py    # å®Œæ•´ç³»ç»Ÿæ¼”ç¤ºè„šæœ¬
```

### ğŸš€ ä½¿ç”¨ç¤ºä¾‹

#### å¼€å‘ç¯å¢ƒå¿«é€Ÿå¼€å§‹
```python
system = await initialize_sessions(enable_all_features=True)
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½®
```python
config = get_production_config(
    storage_config={"db_path": "./prod.db"},
    backup_dir=Path("./backups"),
    archive_dir=Path("./archive")
)
system = await initialize_sessions(**config.__dict__)
```

### ğŸ”„ è¿ç§»è·¯å¾„

1. **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œ
2. **é€æ­¥å‡çº§**: å¯ä»¥é€ä¸ªå¯ç”¨æ–°åŠŸèƒ½æ¨¡å—
3. **å®Œæ•´è¿ç§»**: ä½¿ç”¨å®Œæ•´SessionSystemè·å¾—æ‰€æœ‰åŠŸèƒ½

### ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- âœ… **å†…å­˜ç®¡ç†**: æ™ºèƒ½çš„å†…å­˜ä½¿ç”¨å’Œåƒåœ¾å›æ”¶
- âœ… **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡ä¼šè¯å¤„ç†å’ŒåŒæ­¥
- âœ… **ç¼“å­˜æœºåˆ¶**: å¤šå±‚ç¼“å­˜æå‡è®¿é—®æ€§èƒ½
- âœ… **å¼‚æ­¥å¤„ç†**: å…¨é¢çš„å¼‚æ­¥æ“ä½œæ”¯æŒ

### ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯

- âœ… **é”™è¯¯å¤„ç†**: å…¨é¢çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤
- âœ… **å¥åº·æ£€æŸ¥**: å®æ—¶ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§
- âœ… **è‡ªåŠ¨æ¢å¤**: ç³»ç»Ÿç»„ä»¶çš„è‡ªåŠ¨æ¢å¤æœºåˆ¶
- âœ… **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è·Ÿè¸ª

## ğŸ”® æœªæ¥æ‰©å±•

### å¯èƒ½çš„å¢å¼ºåŠŸèƒ½
- ğŸ¤– **AIæ™ºèƒ½**: é›†æˆAIè¿›è¡Œä¼šè¯è´¨é‡åˆ†æå’Œä¼˜åŒ–
- ğŸ“± **ç§»åŠ¨ç«¯æ”¯æŒ**: ä¸“é—¨çš„ç§»åŠ¨ç«¯ä¼šè¯ç®¡ç†
- ğŸŒ **åˆ†å¸ƒå¼**: æ”¯æŒå¤šèŠ‚ç‚¹åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†
- ğŸ“Š **å¯è§†åŒ–**: Webç•Œé¢å’Œå¯è§†åŒ–ä»ªè¡¨æ¿
- ğŸ” **å®‰å…¨å¢å¼º**: æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶å’Œå®‰å…¨å®¡è®¡

---

**AgentBusä¼šè¯ç®¡ç†ç³»ç»Ÿç°åœ¨æä¾›äº†ä¼ä¸šçº§çš„å®Œæ•´ä¼šè¯ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒä»ç®€å•çš„åº”ç”¨åˆ°å¤æ‚çš„ä¼ä¸šéƒ¨ç½²çš„æ‰€æœ‰éœ€æ±‚ã€‚**